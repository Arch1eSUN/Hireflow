# HireFlow AI — 现状评审与上线落地方案（Rev 8）

> **文档用途**：作为当前代码真实状态的“上线评审基线”，用于回答：现在做到哪了、还差什么、多久能上线、接下来怎么做。  
> **Last Updated**：2026-02-14  
> **Revision**：8（替换旧版 Rev 7 的过时结论，按当前代码与验证结果重写）

---

## 0. 结论先行（Executive Summary）

1. **项目已从“UI 原型”进入“可运行 MVP + 监控链路”阶段**，核心业务链路（认证、岗位/候选人/面试、筛选规则、面试监控、证据导出）已具备。
2. **当前不适合直接生产上线**，主要卡点不是“功能缺失”，而是：
   - 安全与配置硬化（默认密钥回退、环境校验、生产配置治理）
   - 工程质量闸门（`type-check` 未全绿）
   - 端到端验证与运维落地（自动化、部署、监控、告警、备份）
3. **进度评估（面向正式上线）**：约 **72%**。  
   - 功能完成度高（约 82%）
   - 但上线工程化成熟度偏低（约 55%-60%）
4. **时间预估（按 2-3 名全职开发，需求不大改）**：
   - **可控 Beta**：还需 **3-4 周**（预计 2026-03-14 ~ 2026-03-28）
   - **生产上线**：还需 **6-8 周**（预计 2026-04-04 ~ 2026-04-25）

---

## 1. 代码现况（按模块）

### 1.1 Portal 管理端（`apps/portal`）

**已具备能力**
- 认证流：登录/注册/refresh/logout 基础链路可用。
- 招聘核心：Candidates / Jobs / Interviews / Screening / Analytics / Settings 页面齐全。
- 监控中心：实时监控页已具备
  - 策略配置与模板应用
  - 策略历史与回滚
  - 证据导出（JSON/CSV/Bundle）
  - Evidence Timeline（含筛选、详情、导出）
- UI 方向：整体向 Google/Material 风格演进，信息密度与可读性较好。

**现存问题**
- API 与 WS 地址仍存在本地回退写法（`localhost`），生产环境切换风险高。
- `InterviewMonitorPage` 逻辑体量偏大，后续维护与回归成本高。

### 1.2 Interview 面试者端（`apps/interview`）

**已具备能力**
- Landing / Device Check / Waiting / Interview / Complete 完整流程。
- 面试房间：
  - 全屏与屏幕共享约束
  - 违规事件采集上报
  - WebSocket 实时消息
  - WebRTC 屏幕流信令
  - 代码同步（管理端镜像）
  - 剪贴板/快捷键限制（策略可控）

**现存问题**
- `InterviewRoomPage` 单文件职责过重（安全策略、音频、WS、WebRTC、UI 混杂）。
- 存在 `localhost` 回退逻辑，生产域名场景下容易出现连接误判。
- TS 静态检查存在 1 个明确错误（见第 2 节验证结果）。

### 1.3 Backend（`server/src`）

**已具备能力**
- Fastify 模块化路由（auth/jobs/candidates/interviews/screening/settings/websocket/...）。
- JWT + refresh cookie 认证体系。
- AI Gateway 多 provider（OpenAI/Gemini/Claude/Local）与 key 管理。
- 监控策略模板、历史、回滚、批量下发（含 dry-run）。
- 证据导出记录接口与时间轴聚合接口。
- WebSocket 房间态与 candidate/monitor 分权连接。

**现存问题**
- 安全默认值存在“开发兜底密钥”风险（JWT / cookie secret / encryption key）。
- 仍保留旧版 `server/index.ts`（历史文件），有误用与认知混淆风险。
- 生产级运行能力未完整闭环（迁移/备份/监控/告警/runbook）。

### 1.4 数据层（Prisma/Postgres）

**已具备能力**
- 关键业务实体已建模（Company/User/Job/Candidate/Interview/Settings/Audit/...）。
- 首个初始化迁移已存在。

**现存问题**
- 仅有初始迁移，后续演进策略与回滚预案不足。
- 索引、审计数据保留策略、归档策略尚未显式标准化。

---

## 2. 当前可复现验证结果（2026-02-14 实测）

### 2.1 构建
- 命令：`npm run build`
- 结果：**通过**（portal/interview/server 全通过）

### 2.2 类型检查
- 命令：`npm run type-check`
- 结果：**失败（1 个错误）**
- 错误位置：`apps/interview/src/pages/DeviceCheckPage.tsx:61`
- 问题类型：TS2774（条件永真）

### 2.3 E2E API 脚本
- 命令：`npm run test:e2e:api`
- 结果：**失败**（不是逻辑断言失败，而是 server 未启动）
- 报错：`Cannot reach server health endpoint`（提示需先 `npm run dev:server`）

---

## 3. 现存问题清单（按优先级）

### P0（上线阻断）
1. **类型检查未全绿**  
   - `apps/interview/src/pages/DeviceCheckPage.tsx:61`
2. **安全兜底密钥存在生产误用风险**  
   - `server/src/utils/encryption.ts:5`（固定默认密钥）
   - `server/src/utils/jwt.ts:3`（JWT 默认 secret）
   - `server/src/index.ts:63`（cookie secret 默认值）
   - `server/src/routes/websocket.ts:39`（JWT verify 默认 secret）
3. **生产环境配置治理不完整**  
   - 多处 `localhost` 回退（Portal/Interview/API/WS）

### P1（高优先优化）
1. **大页面文件过重，维护成本高**  
   - `apps/interview/src/pages/InterviewRoomPage.tsx`
   - `apps/portal/src/pages/InterviewMonitorPage.tsx`
2. **旧入口文件残留，影响团队认知一致性**  
   - `server/index.ts` 与 `server/src/index.ts` 并存
3. **E2E 缺乏一键可执行基础设施**  
   - 当前脚本依赖人工提前启动服务

### P2（持续改进）
1. README 与实际能力不一致（文档滞后）。
2. 关键接口契约（WS 消息）尚未形成严格 schema + 版本策略。
3. 监控证据与审计日志增长后的性能与归档策略需前置。

---

## 4. 可能出现的问题（未来 1-3 个月）

1. **浏览器安全边界导致“绝对防作弊”不可达**  
   - Web 端无法真正“杜绝所有外挂插件”；只能做到行为检测、证据留痕、策略处置。
2. **实时链路扩展性风险**  
   - WebSocket/房间状态目前偏单体内存态，横向扩容需要引入 Redis pub/sub 或事件总线。
3. **合规风险**  
   - 屏幕录制、行为监测、自动终止需匹配用户同意、地区合规与告知文本。
4. **可靠性风险**  
   - 若无明确 SLO、告警、故障演练，生产后问题定位成本会快速上升。

---

## 5. 后续建议新增功能（面向差异化与蓝海切口）

> 招聘/ATS 本身是红海；要进入相对蓝海，需要把“可信面试基础设施 + 可审计能力 + 招聘决策智能”做成壁垒。

### 5.1 必做（上线前）
1. **候选人合规同意中心**：面试前明确展示监控范围、数据用途、保存时长、撤回机制。
2. **监控策略模板库**：按岗位类型（前端/后端/算法/非技术）提供预设策略。
3. **告警联动动作**：高危事件触发自动标记、提醒、暂停建议流程。

### 5.2 蓝海增强（上线后 1-2 个版本）
1. **可验证证据链（Evidence Hash Chain）**
   - 对关键事件做哈希串联，导出后可验真，提升争议场景可信度。
2. **AI 面试质量回放与二次复评（Second Opinion）**
   - 允许第二模型复评并给出分歧解释，降低单模型偏差。
3. **岗位能力图谱与题目自适应编排**
   - 依据岗位能力维度自动调题，提高区分度与公平性。
4. **面试官协同战情室（实时批注 + 评分同步）**
   - 管理端多人协同观察同一场面试，提高团队决策效率。

---

## 6. 现有代码优化与修改建议

### 6.1 前端（Google 风格继续收口）
1. 建立统一 Design Tokens（颜色/间距/层级/状态）并抽成共享样式层。
2. 将 `InterviewRoomPage` 拆分为：
   - `useSecureMode`
   - `useScreenShareGuard`
   - `useInterviewSocket`
   - `useCodeSync`
   - `SecureOverlay` / `InterviewWorkspace` 组件
3. 将 `InterviewMonitorPage` 拆分为：
   - 实时面板
   - 策略面板
   - 证据中心
   - 时间轴回放
4. 去除硬编码 `localhost`，统一使用环境变量与运行时配置注入。

### 6.2 后端
1. 新增 `env` 校验层（zod）：启动时强校验关键密钥，不允许生产默认值回退。
2. 清理旧入口 `server/index.ts`，统一 `server/src/index.ts`。
3. WebSocket 消息体 schema 化（shared types + runtime validation）。
4. 引入幂等与限流策略到关键写接口（策略下发、证据导出、回滚）。

### 6.3 数据与运维
1. 增加 Prisma 迁移规范：版本命名、回滚策略、发布检查。
2. 为高频查询补索引（按 interviewId、createdAt、action）。
3. 增加审计日志归档任务，避免主库膨胀。
4. 建立最小上线运维集：
   - 健康检查
   - error 监控
   - 告警通道
   - 备份与恢复演练

---

## 7. 距离正式上线还差多久？进度是多少？

### 7.1 进度量化（以“正式上线”口径）

- 产品功能完成度：**82%**
- 前端体验完成度：**78%**
- 后端能力完成度：**76%**
- 安全与合规完成度：**50%**
- 测试与运维完成度：**52%**

**综合进度：约 72%**

### 7.2 工期预估（从 2026-02-14 起）

1. **Beta（受控试运行）**：3-4 周  
   - 目标窗口：**2026-03-14 ~ 2026-03-28**
2. **Production（正式上线）**：6-8 周  
   - 目标窗口：**2026-04-04 ~ 2026-04-25**

> 前提：需求范围不大幅扩张；并行推进“安全硬化 + QA + 运维落地”。

---

## 8. 深度开发方案（建议执行）

### Phase 0（第 1 周）：上线阻断清零

**目标**：把“不能上线”的硬阻断全部清掉。  
**任务**：
1. 修复 `type-check` 唯一错误。
2. 移除默认密钥回退，补齐启动时环境变量校验。
3. 清理旧 `server/index.ts`，统一启动入口。
4. 统一 API/WS 环境配置，清理 `localhost` 回退。

**验收标准**：
- `npm run build` 通过
- `npm run type-check` 全绿
- 生产模式启动时缺失关键 ENV 直接 fail-fast

### Phase 1（第 2-3 周）：质量与可运维能力

**目标**：具备可持续交付与可观测能力。  
**任务**：
1. E2E 脚本升级为一键（自动预检并可选自动拉起依赖）。
2. 增加 API 合同测试与关键流程冒烟测试。
3. 接入错误监控（Sentry 类）与结构化日志聚合。
4. 建立部署前检查清单（migrate、seed、health、rollback）。

**验收标准**：
- 主链路 E2E 可在标准环境稳定跑通
- 核心错误可在监控平台追踪
- 发布有标准化 runbook

### Phase 2（第 4-5 周）：体验与差异化增强

**目标**：提升产品竞争力与可用性。  
**任务**：
1. 前端页面模块化拆分，降低维护复杂度。
2. 监控策略模板库（岗位预设 + 组织级策略继承）。
3. 证据链导出增强（时间轴、摘要、可复核视图）。
4. 合规同意与告知流程完善。

**验收标准**：
- 大页面拆分完成，关键逻辑可单测
- 监控策略可复用与批量治理
- 合规流程在候选人端可见且有记录

### Phase 3（第 6-8 周）：上线冲刺

**目标**：达到正式上线标准。  
**任务**：
1. 压测与容量评估（WS 房间并发、证据导出峰值）。
2. 安全扫描与权限回归。
3. 灰度发布 + 回滚演练。
4. 上线后首月指标看板（激活率、完成率、告警率、故障 MTTR）。

**验收标准**：
- 压测达到目标阈值
- 安全与权限问题闭环
- 灰度/回滚流程已演练
- 可观测指标上线并稳定

---

## 9. 市场判断（红海/蓝海）与实际利用率预估

### 9.1 市场属性

- **主赛道**（ATS + 面试管理）是典型红海，竞品多、同质化高。
- **可切入蓝海的细分点**：
  1. 可审计、可验证的远程面试监控与证据体系
  2. 面向企业风控/合规的“可信面试基础设施”
  3. 多模型复评与偏差解释能力

### 9.2 利用率与落地概率（基于当前能力）

- 若仅做通用 ATS 功能：利用率提升空间有限，易陷价格竞争。
- 若强化“可信监考 + 可审计证据 + 复评能力”：
  - 在中大型企业、外包交付、技术面试场景中，实际采用率更高。
  - 预计可形成更强付费意愿与更低替代性。

---

## 10. 下一步（建议立即执行）

1. 先完成 **Phase 0**（1 周内完成上线阻断清零）。
2. 同步更新 `README.md` 与本文件，确保文档与代码一致。
3. 以“Beta 上线”为目标建立每周可验收里程碑，避免功能继续堆积造成延期。

